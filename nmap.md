# Nmap

## Table of content

- [Nmap](#nmap)
  - [Table of content](#table-of-content)
  - [1. La découverte des hôtes :](#1-la-d%c3%a9couverte-des-h%c3%b4tes)
  - [2. Le scan de ports :](#2-le-scan-de-ports)
  - [3. La détection de service :](#3-la-d%c3%a9tection-de-service)
  - [4. Les scripts :](#4-les-scripts)
    - [1. Default :](#1-default)
    - [2. Web :](#2-web)

## 1. La découverte des hôtes :

-PN  : No ping

-PR  : Scan ARP

```shell
nmap -PN <network address>/<CIDR>

Nmap scan report for <ip>
Host is up (0.0039s latency).
Not shown: 997 closed ports
PORT     STATE SERVICE
80/tcp   open  http
443/tcp  open  https
8080/tcp open  http-proxy
MAC Address: <mac address> (brand)

Nmap scan report for <ip>
Host is up (0.0029s latency).
Not shown: 984 filtered ports
PORT      STATE SERVICE
53/tcp    open  domain
88/tcp    open  kerberos-sec
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
389/tcp   open  ldap
445/tcp   open  microsoft-ds
464/tcp   open  kpasswd5
593/tcp   open  http-rpc-epmap
636/tcp   open  ldapssl
3268/tcp  open  globalcatLDAP
3269/tcp  open  globalcatLDAPssl
49154/tcp open  unknown
49155/tcp open  unknown
49157/tcp open  unknown
49158/tcp open  unknown
49159/tcp open  unknown
MAC Address: <mac address> (Unknown)

```

## 2. Le scan de ports :

-sS  : Scan SYN

-sU  : Scan UDP

-p   : Port/range cible

```shell
nmap -sS -sU <ip> -p <port/range>

Starting Nmap 7.80 ( https://nmap.org ) at 0000-00-00 xx:xx UTC
Nmap scan report for 10.0.0.xx
Host is up (0.0051s latency).
Not shown: 996 open|filtered ports, 984 filtered ports
PORT      STATE SERVICE
53/tcp    open  domain
88/tcp    open  kerberos-sec
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
389/tcp   open  ldap
445/tcp   open  microsoft-ds
464/tcp   open  kpasswd5
593/tcp   open  http-rpc-epmap
636/tcp   open  ldapssl
3268/tcp  open  globalcatLDAP
3269/tcp  open  globalcatLDAPssl
49154/tcp open  unknown
49155/tcp open  unknown
49157/tcp open  unknown
49158/tcp open  unknown
49159/tcp open  unknown
53/udp    open  domain
123/udp   open  ntp
137/udp   open  netbios-ns
389/udp   open  ldap
MAC Address: XX:XX:XX:XX:XX:XX (Unknown)

```

Les six états de port reconnus par Nmap

1. ouvert (open)

    Une application accepte des connexions TCP ou des paquets UDP sur ce port. Trouver de tels ports est souvent le but principal du scan de ports. Les gens soucieux de la sécurité savent pertinemment que chaque port ouvert est un boulevard pour une attaque. Les attaquants et les pen-testers veulent exploiter ces ports ouverts, tandis que les administrateurs essaient de les fermer ou de les protéger avec des pare-feux sans gêner leurs utilisateurs légitimes. Les ports ouverts sont également intéressants pour des scans autres que ceux orientés vers la sécurité car ils indiquent les services disponibles sur le réseau.

2. fermé (closed)

    Un port fermé est accessible (il reçoit et répond aux paquets émis par Nmap), mais il n'y a pas d'application en écoute. Ceci peut s'avérer utile pour montrer qu'un hôte est actif (découverte d'hôtes ou scan ping), ou pour la détection de l'OS. Comme un port fermé est accessible, il peut être intéressant de le scanner de nouveau plus tard au cas où il s'ouvrirait. Les administrateurs pourraient désirer bloquer de tels ports avec un pare-feu, mais ils apparaîtraient alors dans l'état filtré décrit dans la section suivante.

3. filtré (filtered)

    Nmap ne peut pas toujours déterminer si un port est ouvert car les dispositifs de filtrage des paquets empêchent les paquets de tests (probes) d'atteindre leur port cible. Le dispositif de filtrage peut être un pare-feu dédié, des règles de routeurs filtrants ou un pare-feu logiciel. Ces ports ennuient les attaquants car ils ne fournissent que très peu d'informations. Quelques fois ils répondent avec un message d'erreur ICMP de type 3 code 13 (« destination unreachable: communication administratively prohibited »), mais les dispositifs de filtrage qui rejettent les paquets sans rien répondre sont bien plus courants. Ceci oblige Nmap à essayer plusieurs fois au cas où ces paquets de tests seraient rejetés à cause d'une surcharge du réseau et pas du filtrage. Ceci ralenti terriblement les choses.

4. non-filtré (unfiltered)

    L'état non-filtré signifie qu'un port est accessible, mais que Nmap est incapable de déterminer s'il est ouvert ou fermé. Seul le scan ACK, qui est utilisé pour déterminer les règles des pare-feux, catégorise les ports dans cet état. Scanner des ports non-filtrés avec un autre type de scan, comme le scan Windows, SYN ou FIN peut aider à savoir si un port est ouvert ou pas.

5. ouvert|filtré (open|filtered)

    Nmap met dans cet état les ports dont il est incapable de déterminer l'état entre ouvert et filtré. Ceci arrive pour les types de scans où les ports ouverts ne renvoient pas de réponse. L'absence de réponse peut aussi signifier qu'un dispositif de filtrage des paquets a rejeté le test ou les réponses attendues. Ainsi, Nmap ne peut s'assurer ni que le port est ouvert, ni qu'il est filtré. Les scans UDP, protocole IP, FIN, Null et Xmas catégorisent les ports ainsi.

6. fermé|filtré (closed|filtered)

    Cet état est utilisé quand Nmap est incapable de déterminer si un port est fermé ou filtré. Cet état est seulement utilisé par le scan Idle basé sur les identifiants de paquets IP.


## 3. La détection de service :

-sV  : Active la detection de version

-O   : Active la detection d'OS

-A   : Dectection de version + OS

--version-intensity [intensity]  : 1-9

--version-light  : Dectection de version rapide

```shell
nmap -sS -sU -sV <ip> -p <port/range>

Starting Nmap 7.80 ( https://nmap.org ) at 0000-00-00 xx:xx UTC
Nmap scan report for 10.0.0.xx
Host is up (0.011s latency).
PORT    STATE SERVICE VERSION
389/tcp open  ldap    Microsoft Windows Active Directory LDAP (Domain: pentest.local, Site: Default-First-Site-Name)
389/udp open  ldap    Microsoft Windows Active Directory LDAP (Domain: pentest.local, Site: Default-First-Site-Name)
MAC Address: XX:XX:XX:XX:XX:XX(Unknown)
Service Info: Host: WIN-MU2BFCFLUUI; OS: Windows; CPE: cpe:/o:microsoft:windows
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 6.85 seconds
```

## 4. Les scripts :

### 1. Default :

- Detecter si eternalblueABLE

```shell
nmap --script smb-vuln-ms17-010 -v 10.10.0.100
```
- [Nmap NSE Script for Recon](https://hackertarget.com/7-nmap-nse-scripts-recon/)
- [Nmap Script usages](https://www.tecmint.com/use-nmap-script-engine-nse-scripts-in-linux/)

```shell
nmap --script default,broadcast 192.168.56.1
nmap -sV --script=exploit,vuln,auth,default 192.168.1.163 -oX rapport.xml
```

### 2. Web :

- [Esssentials Nmap scripts for web pentesting](https://medium.com/@int0x33/day-63-top-10-essential-nmap-scripts-for-web-app-hacking-c7829ff5ab7)

- http-methods
